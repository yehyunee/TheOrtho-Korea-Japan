<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>등록 완료 | WEBCEPH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}</style>
</head>
<body class="min-h-screen bg-slate-50">
  <main class="mx-auto max-w-xl px-4 py-10">
    <section id="card" class="rounded-2xl border bg-white shadow-sm p-6">
      <div id="loading">
        <div class="flex items-center gap-3">
          <div class="h-2.5 w-2.5 rounded-full bg-amber-500 animate-pulse"></div>
          <h1 class="text-xl font-bold">결제 결과 확인 중…</h1>
        </div>
        <p class="mt-2 text-sm text-slate-600">잠시만 기다려 주세요.</p>
      </div>

      <div id="success" class="hidden">
        <div class="flex items-center gap-3">
          <div class="h-6 w-6 rounded-full bg-emerald-500 flex items-center justify-center text-white">✓</div>
          <h1 class="text-xl font-bold">등록이 완료되었습니다</h1>
        </div>
        <p class="mt-2 text-sm text-slate-600">이메일로 확인 안내를 전송했습니다.</p>

        <div class="mt-5 grid grid-cols-1 gap-3 text-sm">
          <div class="rounded-xl border p-4 bg-slate-50">
            <div class="text-slate-500">등록번호</div>
            <div id="regId" class="font-medium break-all"></div>
          </div>
          <div class="rounded-xl border p-4 bg-slate-50">
            <div class="text-slate-500">신청자</div>
            <div id="attendee" class="font-medium break-all"></div>
          </div>
          <div class="rounded-xl border p-4 bg-slate-50">
            <div class="text-slate-500">신청 구분</div>
            <div id="tier" class="font-medium"></div>
          </div>
          <div class="rounded-xl border p-4 bg-slate-50">
            <div class="text-slate-500">결제 금액</div>
            <div id="amount" class="font-medium"></div>
          </div>
        </div>

        <div class="mt-6 flex flex-col gap-3">
          <!-- 확인서(또는 영수증) 보기 -->
          <!-- <a id="receiptLink" href="#" target="_blank"
             class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
            등록 확인서 보기
          </a> -->
          <!-- 세미나 안내/FAQ로 이동 -->
          <a href="/"
             class="inline-flex items-center justify-center px-4 py-2 rounded-lg border hover:bg-slate-50">
            세미나 안내 보러가기
          </a>
        </div>

        <!-- 자동 이동(선택): 5초 후 안내 페이지로 -->
        <!-- <p class="mt-4 text-xs text-slate-500">5초 후 세미나 안내 페이지로 이동합니다…</p> -->
      </div>

      <div id="error" class="hidden">
        <div class="flex items-center gap-3">
          <div class="h-6 w-6 rounded-full bg-red-500 flex items-center justify-center text-white">!</div>
          <h1 class="text-xl font-bold">검증에 실패했습니다</h1>
        </div>
        <p id="errMsg" class="mt-2 text-sm text-slate-600">네트워크 또는 서버 오류가 발생했습니다.</p>
        <div class="mt-6 flex gap-3">
          <button id="retry" class="px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-black">다시 시도</button>
          <a href="/" class="px-4 py-2 rounded-lg border hover:bg-slate-50">홈으로</a>
        </div>
      </div>
    </section>
  </main>

<script>
  // ===== API Endpoints =====
  const PORTONE_VERIFY   = "https://api.webceph.com/payments/verify";             // { paymentId }
  const PAYPAL_COMPLETE  = "https://api.webceph.com/payments/paypal/complete";    // { order_id }
  const RECEIPT_BASE     = "https://api.webceph.com/api/registrations";

  // ===== Helpers =====
  const $ = (s) => document.querySelector(s);
  const params   = new URLSearchParams(location.search);
  const method   = (params.get("method") || "").toLowerCase(); // 'portone' | 'paypal' | ''
  const paymentId= params.get("paymentId");                    // PortOne 식별자
  const orderId  = params.get("order_id") || params.get("orderId"); // PayPal 식별자(둘 다 허용)

  function fmtAmount(n, cur) {
    // 통화별 보기 좋은 로케일 자동 선택
    const c = (cur || "").toUpperCase();
    const locale = c === "USD" ? "en-US" : (c === "JPY" ? "ja-JP" : "ko-KR");
    const num = (typeof n === "string") ? Number(n) : n;
    try { return new Intl.NumberFormat(locale).format(num) + (cur ? " " + c : ""); }
    catch { return (n ?? "") + (cur ? " " + c : ""); }
  }

  function showSuccess(data) {
    $("#loading").classList.add("hidden");
    $("#error").classList.add("hidden");
    $("#success").classList.remove("hidden");

    $("#regId").textContent = data.registration_id || "(발급됨)";
    const name  = data?.attendee?.name  || "";
    const email = data?.attendee?.email || "";
    $("#attendee").textContent = [name, email].filter(Boolean).join(" · ");

    // tier 표기 (국문)
    $("#tier").textContent = (data.tier === "resident") ? "전공의" : "일반";

    // 금액
    $("#amount").textContent = fmtAmount(data.amount, data.currency);

    // (선택) 등록 확인서 링크가 있을 때만 노출
    const regId = data.registration_id;
    const receiptEl = $("#receiptLink");
    if (receiptEl) {
      if (regId) {
        receiptEl.href = `${RECEIPT_BASE}/${encodeURIComponent(regId)}/receipt`;
        receiptEl.classList.remove("hidden");
      } else {
        receiptEl.classList.add("hidden");
      }
    }
  }

  function showError(msg) {
    $("#loading").classList.add("hidden");
    $("#success").classList.add("hidden");
    $("#error").classList.remove("hidden");
    $("#errMsg").textContent = msg || "오류가 발생했습니다.";
  }

  async function verify() {
    // 어떤 결제인지 판별: 명시된 method 우선, 없으면 파라미터 존재 여부로 추론
    let url = "";
    let body = null;

    if (method === "paypal" || (!method && orderId)) {
      if (!orderId) return showError("결제 식별자(order_id)가 없습니다.");
      url  = PAYPAL_COMPLETE;
      body = { order_id: orderId };
    } else if (method === "portone" || (!method && paymentId)) {
      if (!paymentId) return showError("결제 식별자(paymentId)가 없습니다.");
      url  = PORTONE_VERIFY;
      body = { paymentId };
    } else {
      return showError("결제 식별자가 없습니다.");
    }

    try {
      const res  = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json().catch(() => ({}));

      if (res.ok && data.verified) {
        showSuccess(data);
      } else {
        const reason = data?.reason || ("HTTP " + res.status);
        showError("결제 검증에 실패했습니다. (" + reason + ")");
      }
    } catch (err) {
      showError("네트워크 또는 서버 오류가 발생했습니다.");
    }
  }

  $("#retry")?.addEventListener("click", () => location.reload());
  verify();
</script>
</body>
</html>

